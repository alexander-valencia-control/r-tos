---
title: "Evolución de las comunidades"
author: "Angel"
date: "29/4/2020"
output: html_document
---
Cargar paquetes.
```{r}
  library(tidyr)
  library(bibliometrix)
  library(tibble)
  library(igraph)
  library(ggplot2)
```

Cargar consulta de WoS.
```{r}
df_wos <- convert2df(file = "data/savedrecs (78).txt",
                     dbsource = "isi",
                     format = "plaintext")

df_wos$ID_WOS <- row.names(df_wos)

df_wos$ID_WOS <- ifelse(!is.na(df_wos$VL),
                        paste(df_wos$ID_WOS,
                              df_wos$VL,
                              sep = ", V"),
                        df_wos$ID_WOS)

df_wos$ID_WOS <- ifelse(!is.na(df_wos$BP),
                        paste(df_wos$ID_WOS,
                              df_wos$BP,
                              sep = ", P"),
                        df_wos$ID_WOS)

df_wos$ID_WOS <- ifelse(!is.na(df_wos$DI),
                        paste(df_wos$ID_WOS,
                              sep = ", DOI "),
                        df_wos$ID_WOS)

# Red de citaciones. 
network_citation <- 
  as_tibble(df_wos) %>% 
  select(ID_WOS, CR, PY) %>% 
  na.omit() %>% 
  separate_rows(CR, sep = ";") %>% 
  arrange(PY)
names(network_citation) <- c("source", "target", "year")
```

Cargar funciones componente gigante y production_sub_area.
```{r}
big_graph <- function(grafo){
  graph_x <- simplify(grafo)
  graph_x <- delete.vertices(graph_x,
                             which(degree(graph_x, mode = "in") == 1 &
                                   degree(graph_x, mode = "out") == 0))
  cl <- clusters(graph_x)
  graph_x <- induced.subgraph(graph_x,
                              which(cl$membership == which.max(cl$csize)))
}

source('production_sub_areas.R')
```

Evolución de las comunidades (y su producción) por año.
```{r}
minimo <- min(unique(network_citation$year))
maximo <- max(unique(network_citation$year))

evolution_production_cluster <- tibble()
evolution_num_clusters <- tibble()

for (i in minimo:maximo){
  graph <-
    network_citation %>% 
    filter(year <= i) %>% 
    select(source, target) %>% 
    graph.data.frame(directed = TRUE)
  
  graph <- big_graph(graph)
  prod_cluster <- production_sub_area(graph)
  
  evolution_num_clusters <- append(evolution_num_clusters,
                                   length(prod_cluster$length_comunities$sub_area))
  
  ploting <-
    ggplot(prod_cluster$production, aes(x=Year, y=frecuencia, color=sub_areas)) +
      geom_point(size=0.6) +
      geom_line() +
      labs(title = paste("Producción sub_area", as.character(i), sep = ""),
           x = "Years",
           y = "Frecuencia")
  #print(ploting)

  names(prod_cluster) <- c(paste("Level_", as.character(i), "_production", sep = ""),
                           paste("Level_", as.character(i), "_graph", sep = ""),
                           paste("Level_", as.character(i), "_length", sep = ""))
  
  evolution_production_cluster <- append(evolution_production_cluster,
                                         prod_cluster)
}


```


